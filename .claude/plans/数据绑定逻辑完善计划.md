# 数据绑定逻辑完善计划
## 现状分析
当前已实现：数据源 CRUD、表达式解析/求值（`{{$state.xxx}}`/`{{$item.xxx}}`/`{{$ds.xxx}}`）、List 循环绑定、Input 双向绑定、条件渲染、事件动作（navigate/showToast/setState/submitForm）、代码生成。
## 发现的问题
### P0 - 功能缺陷
1. **页面跳转未联动页面列表** — navigate action 的目标 URL 是手动文本输入（PropsPanel.tsx:631-643），应提供已有页面的下拉选择
2. **Textarea/Switch 缺少双向绑定** — 只有 Input 组件有「绑定到状态变量」的简化 UI（PropsPanel.tsx:414-471），Textarea 和 Switch 同样需要
3. **状态变量无独立管理 UI** — formStates 只在 Input 绑定时自动创建，缺少独立的增删改查面板；用户无法手动添加/删除/修改状态变量
### P1 - 体验优化
4. **属性绑定无表达式辅助** — 普通 string prop 只能手动输入 `{{$state.xxx}}`，缺少快捷绑定按钮
5. **代码生成：数据源未按页面过滤** — transformer.ts:96 将全部 dataSources 生成到每个页面的 stateVars/effects 中，应只生成该页面实际引用的数据源
6. **Preview HTML 不处理条件渲染和 $state** — html-renderer.ts 的 renderNode 忽略了 condition 节点，resolveExpressions 不处理 $state 变量
### P2 - 健壮性
7. **setState value 类型安全** — setState action 的 value 始终是字符串，对 number/boolean 类型的目标变量应在代码生成时做类型转换
8. **Mock 数据格式不统一** — 有的地方期望 `{data:[...]}` 有的期望纯数组，应统一约定并校验
## 实施方案
### 1. 页面跳转联动页面列表（P0）
文件：`packages/editor/src/components/PropsPanel.tsx`
- navigate action 编辑区域，将文本 input 替换为 select（从 schema.pages 生成 options，值为 page.path）+ 手动输入切换
### 2. Textarea/Switch 双向绑定（P0）
文件：`packages/editor/src/components/PropsPanel.tsx`
- 复用 Input 绑定逻辑，增加 Textarea 和 Switch 分支
- Textarea：onChange → setState，value 绑定表达式
- Switch：onChange → setState，checked 绑定表达式，formState type 为 boolean
### 3. 状态变量管理面板（P0）
文件：新建 `packages/editor/src/components/StatePanel.tsx`，修改 PropsPanel.tsx
- 新建 StatePanel 组件：列表显示所有 formStates，支持添加（指定 id、type、defaultValue）、编辑、删除
- 在 PropsPanel「可用状态变量」区域增加「管理」入口
### 4. 属性绑定表达式辅助（P1）
文件：`packages/editor/src/setters/index.tsx`
- 为 StringSetter 增加绑定图标按钮，点击后切换为 ExpressionSetter 模式
- ExpressionSetter 已有可视化构建器，可直接复用
### 5. 代码生成按页面过滤数据源（P1）
文件：`packages/codegen-core/src/transformer.ts`
- 在 transformPageToIR 中遍历 pageDef.componentTree，收集所有被引用的 dataSourceId（来自 node.loop.dataSourceId 和 node.props 中的 `$ds.xxx` 引用）
- 只为该页面实际引用的 dataSources 生成 stateVars 和 effects
### 6. Preview HTML 支持条件渲染和 $state（P1）
文件：`packages/codegen-core/src/html-renderer.ts`
- renderNode 中检查 node.condition，若条件值为 false 则跳过渲染
- resolveExpressions 增加 $state 变量替换（从 stateVars 的 defaultValue 中取值）
### 7. setState 类型安全（P2）
文件：`packages/codegen-core/src/transformer.ts`
- generateHandlerBody 中对 setState action，根据目标 formState 的 type 生成类型转换代码（如 `Number(...)` 或 `Boolean(...)`）
### 8. Mock 数据格式统一（P2）
文件：`packages/editor/src/components/DataSourcePanel.tsx`, `packages/editor/src/renderer/Renderer.tsx`
- DataSourcePanel 保存时统一将 mockData 包装为 `{data: [...]}` 标准格式
- Renderer 中 mockData 读取逻辑做兼容处理（已部分存在，需确保一致）
## 优先级建议
按 P0 → P1 → P2 顺序实施。P0 是用户可感知的功能缺陷，P1 提升开发体验，P2 增强健壮性。