# 数据源体系重新设计（真实接口驱动）

## 问题分析
当前数据源依赖 mock 数据，字段选择器不工作，不支持 CRUD 全场景。

**目标**：
1. 去掉 mock 数据，所有数据源直接对接真实 API
2. 通过「测试接口」按钮获取真实返回，自动提取字段 schema
3. 组件可以根据字段 schema 选择要显示的字段
4. 支持查询（GET）和操作（POST/PUT/DELETE）两种用途

## 新的 DataSourceDef 类型

```typescript
interface DataSourceDef {
  id: string
  type: 'api'
  purpose: 'query' | 'mutation'     // 查询 vs 操作
  label?: string                      // 显示名称，如「获取商品列表」
  options: {
    url: string
    method: 'GET' | 'POST' | 'PUT' | 'DELETE'
    headers?: Record<string, string>
    body?: string                     // mutation 请求体 JSON 模板
  }
  autoFetch: boolean                  // query 默认 true，mutation 默认 false
  responseFields?: FieldSchema[]      // 从真实接口返回自动提取
  sampleData?: unknown[]              // 缓存的接口返回数据（预览用，取前3条）
  dependsOn?: string[]
}

interface FieldSchema {
  name: string
  type: 'string' | 'number' | 'boolean' | 'object' | 'array'
}
```

**与现有的区别**：
- 去掉 `mockData`，改为 `sampleData`（从真实接口缓存）
- 新增 `purpose`（区分查询/操作）
- 新增 `label`（可读名称）
- `method` 扩展为 GET/POST/PUT/DELETE
- 新增 `responseFields`（字段 schema，从接口返回提取）
- 新增 `options.body`（mutation 请求体模板）

## 工作流程

### 配置数据源
1. 用户填写 URL、选择方法和用途
2. 点击「测试接口」→ 编辑器发起真实请求
3. 从返回结果自动提取字段 schema → 存入 `responseFields`
4. 缓存前 3 条数据 → 存入 `sampleData`（仅用于编辑器预览）
5. 保存数据源

### 绑定字段
1. List 组件选择 query 类型数据源
2. List 子组件（Text/Image 等）属性面板显示字段下拉（来自 `responseFields`）
3. 选择字段后自动填入 `{{$item.fieldName}}`

### 编辑器预览
- 用 `sampleData` 渲染预览（不是 mock，是真实接口的缓存）
- 没有 sampleData 时显示「请先测试接口」提示

### 代码生成
- query 类型 → 生成 useEffect + Taro.request
- mutation 类型 → 生成请求函数，供事件 handler 调用

## 实施步骤

### Step 1: Protocol 类型更新
文件: `packages/protocol/src/types.ts`
- 更新 `DataSourceDef`：新增 purpose、label、responseFields、sampleData，去掉 mockData
- 新增 `FieldSchema` 类型
- method 扩展为 4 种

### Step 2: 字段提取工具函数
新文件: `packages/editor/src/utils/field-extractor.ts`
- `extractFieldsFromData(data: unknown): FieldSchema[]` — 从 API 返回提取字段
- `extractListFromResponse(data: unknown): any[]` — 从响应中提取数组（兼容多种格式）

### Step 3: DataSourcePanel UI 重写
文件: `packages/editor/src/components/DataSourcePanel.tsx`
- 添加 purpose 选择（查询/操作）
- 去掉 mock 数据编辑区域
- 测试接口后自动提取字段并显示
- mutation 类型添加请求体模板编辑
- 数据源列表按用途分组显示，每个 query 数据源显示字段列表摘要

### Step 4: PropsPanel 字段选择器修复
文件: `packages/editor/src/components/PropsPanel.tsx`
- `getDataSourceFields` 改为从 `responseFields` 读取
- 确保 List 子组件字段选择器正常显示
- List 本身显示已绑定的字段摘要

### Step 5: Store 适配
文件: `packages/editor/src/store.ts`
- addDataSource / updateDataSource 适配新字段
- 向后兼容：导入旧 schema 时 mockData → sampleData 迁移

### Step 6: Renderer 预览适配
文件: `packages/editor/src/renderer/Renderer.tsx`
- 将 `mockData` 引用改为 `sampleData`

### Step 7: Transformer 代码生成适配
文件: `packages/codegen-core/src/transformer.ts`
- query 数据源：用 sampleData 作为默认值，生成 fetch 逻辑
- mutation 数据源：生成请求函数，不自动 fetch
- 支持 PUT/DELETE 方法

## 修改范围
- `packages/protocol/src/types.ts` — 类型定义
- `packages/editor/src/utils/field-extractor.ts` — 新文件
- `packages/editor/src/components/DataSourcePanel.tsx` — UI 重写
- `packages/editor/src/components/PropsPanel.tsx` — 字段选择器
- `packages/editor/src/store.ts` — store 适配
- `packages/editor/src/renderer/Renderer.tsx` — 预览适配
- `packages/codegen-core/src/transformer.ts` — 代码生成
