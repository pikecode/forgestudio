# 数据源配置重构方案
## 设计目标
将数据源从全局配置改为**页面级绑定**,并提供**场景化模板**引导配置,降低低代码编辑器的使用门槛。

## 核心问题分析
### 当前痛点
1. **数据源全局管理** - 用户需要理解全局作用域,但实际按页面使用,心智模型不匹配
2. **手写JSON Mock数据** - textarea编辑极易出错,不直观
3. **参数语法陌生** - `{{$param.id}}` 这种语法需要记忆,没有提示
4. **列表-详情场景配置繁琐** - 需要手动创建两个数据源,理解参数传递关系
5. **无数据预览** - 填完mock数据看不到效果

### 用户期望
- 在当前页面直接管理数据源,所见即所得
- 点击按钮快速创建"商品列表接口""商品详情接口"
- 可视化编辑表格数据,自动格式化JSON
- 自动关联参数依赖,明确告知"此页面需要接收id参数"

## 技术架构调整
### 1. 数据模型变更
#### 当前结构
```typescript
interface FSPSchema {
  version: string
  dataSources?: DataSourceDef[]  // 全局
  formStates?: FormStateDef[]    // 全局
  pages?: PageDef[]
}
```

#### 调整后结构
```typescript
interface FSPSchema {
  version: string
  pages?: PageDef[]
  // dataSources 移除,改为页面级
  // formStates 也可考虑移到页面级
}

interface PageDef {
  id: string
  name: string
  title: string
  path: string
  componentTree: ComponentNode
  dataSources?: DataSourceDef[]    // NEW: 页面级数据源
  formStates?: FormStateDef[]      // NEW: 页面级状态
  params?: PageParamDef[]          // NEW: 页面接收的参数定义
}

interface PageParamDef {
  name: string        // 参数名,如 "id"
  type: 'string' | 'number'
  required: boolean
  description?: string  // 用于UI提示
}
```

### 2. 数据源模板系统
#### 预设模板枚举
```typescript
enum DataSourceTemplate {
  LIST = 'list',          // 列表接口
  DETAIL = 'detail',      // 详情接口
  SUBMIT = 'submit',      // 提交接口
  CUSTOM = 'custom'       // 自定义
}

interface DataSourceTemplateConfig {
  template: DataSourceTemplate
  urlTemplate: string        // URL模板,如 "/api/products"
  method: 'GET' | 'POST'
  mockDataGenerator: () => any  // 自动生成mock数据
  requiresParams?: string[]     // 需要的页面参数
}
```

#### 模板实现
```typescript
const TEMPLATES: Record<DataSourceTemplate, DataSourceTemplateConfig> = {
  list: {
    template: DataSourceTemplate.LIST,
    urlTemplate: '/api/{resource}',
    method: 'GET',
    mockDataGenerator: () => ({
      data: [
        { id: 1, title: '示例1', description: '描述1' },
        { id: 2, title: '示例2', description: '描述2' },
        { id: 3, title: '示例3', description: '描述3' }
      ]
    })
  },
  detail: {
    template: DataSourceTemplate.DETAIL,
    urlTemplate: '/api/{resource}/{{$param.id}}',
    method: 'GET',
    requiresParams: ['id'],
    mockDataGenerator: () => ({
      data: {
        id: 1,
        title: '详情示例',
        description: '这是详情内容',
        price: 99
      }
    })
  },
  submit: {
    template: DataSourceTemplate.SUBMIT,
    urlTemplate: '/api/{resource}',
    method: 'POST',
    mockDataGenerator: () => ({
      data: { success: true, message: '提交成功' }
    })
  }
}
```

### 3. Mock数据可视化编辑器
#### 组件结构
```typescript
interface MockDataEditorProps {
  value: any               // 当前mock数据
  onChange: (data: any) => void
  template?: DataSourceTemplate  // 影响默认列结构
}

// 编辑模式
enum EditMode {
  JSON = 'json',    // JSON文本编辑
  TABLE = 'table'   // 表格可视化编辑
}
```

#### 表格编辑器功能
- 自动检测数据结构(从`data`字段提取数组)
- 列头可编辑(添加/删除字段)
- 行可编辑(添加/删除/修改数据)
- 支持基础类型推断(string/number/boolean)
- 实时同步JSON
- 错误提示(格式不合法时)

## UI设计方案
### 1. 数据源配置位置调整
#### 方案A: 集成到页面管理器
在PageManager组件中,每个页面卡片下方显示数据源列表:
```
┌─ 页面管理 ─────────────┐
│ [首页] [详情页] [+ 新页面] │
├────────────────────────┤
│ 📄 首页 (/pages/index) │
│   数据源:               │
│   • productList (列表)  │
│   [+ 添加数据源]        │
├────────────────────────┤
│ 📄 详情页 (/pages/detail)│
│   数据源:               │
│   • productDetail (详情)│
│   需要参数: id          │
└────────────────────────┘
```

#### 方案B: 数据源标签页保留,但显示当前页面
保留右侧面板的"数据源"标签,但顶部显示当前页面:
```
┌─ 数据源 ─────────────────┐
│ 当前页面: 详情页          │
├──────────────────────────┤
│ [快速创建]               │
│ • 列表接口               │
│ • 详情接口 ✓推荐         │
│ • 提交接口               │
│ • 自定义                 │
├──────────────────────────┤
│ 现有数据源:              │
│ productDetail (详情)     │
│ URL: /api/product/{{$param.id}}
│ 需要参数: id (来自页面跳转)
└──────────────────────────┘
```

**推荐: 方案B** - 改动最小,用户习惯延续

### 2. 场景化创建流程
#### 步骤1: 选择模板
```
[快速创建数据源]
┌───────────────────────────────┐
│ 🗂️ 列表接口                   │
│   获取多条数据,用于列表展示   │
├───────────────────────────────┤
│ 📄 详情接口 ⭐                │
│   获取单条数据,需要传入ID     │
├───────────────────────────────┤
│ ✉️ 提交接口                   │
│   POST提交表单数据            │
├───────────────────────────────┤
│ ⚙️ 自定义                     │
│   完全自定义配置              │
└───────────────────────────────┘
```

#### 步骤2: 填写配置
以"详情接口"为例:
```
[创建详情接口]

资源名称: [products]  (用于生成URL)
生成URL: /api/products/{{$param.id}}

⚠️ 此接口需要参数 id
来源: 页面URL参数

📊 Mock数据编辑
[JSON编辑] [表格编辑] ← 切换

当前: 表格编辑模式
┌────┬─────────┬──────────────┬───────┐
│ id │ title   │ description  │ price │
├────┼─────────┼──────────────┼───────┤
│ 1  │ 商品1   │ 这是描述     │ 99    │
└────┴─────────┴──────────────┴───────┘
[+ 添加列] [+ 添加行]

[取消] [创建]
```

### 3. 参数依赖自动检测
#### 检测逻辑
```typescript
function detectUrlParams(url: string): string[] {
  const regex = /\{\{\$param\.(\w+)\}\}/g
  const matches = [...url.matchAll(regex)]
  return matches.map(m => m[1])
}

// 使用示例
const url = '/api/product/{{$param.id}}/reviews/{{$param.reviewId}}'
const params = detectUrlParams(url)  // ['id', 'reviewId']
```

#### UI展示
检测到参数后,在数据源卡片显示提示:
```
┌─ productDetail ───────────────┐
│ GET /api/product/{{$param.id}}│
│                                │
│ 📌 需要参数:                   │
│   • id (string) - 来自页面跳转 │
│                                │
│ 💡 如何传入参数?               │
│   在列表页设置onClick事件:     │
│   动作类型: 页面跳转           │
│   参数: id = {{$item.id}}      │
└────────────────────────────────┘
```

## 实现计划
### Phase 1: 数据架构迁移 (2-3小时)
#### 文件修改
1. `packages/protocol/src/types.ts`
   - PageDef添加dataSources, formStates, params字段
   - FSPSchema标记dataSources为deprecated

2. `packages/protocol/src/index.ts`
   - 添加页面级数据源操作函数:
     - `addDataSourceToPage(page, ds)`
     - `removeDataSourceFromPage(page, dsId)`
     - `findDataSourceInPage(page, dsId)`

3. `packages/editor/src/store.ts`
   - 修改addDataSource等方法,操作currentPage.dataSources
   - 兼容处理: 如果schema.dataSources存在,自动迁移到首页

#### 测试验证
- 创建数据源保存到当前页面
- 切换页面后数据源独立
- 导入旧schema自动迁移数据源

### Phase 2: UI重构 - 模板系统 (3-4小时)
#### 新增组件
1. `DataSourceTemplateSelector.tsx`
   - 模板选择卡片
   - 每个模板显示图标+描述

2. `DataSourceWizard.tsx`
   - 分步表单
   - 根据模板预填配置
   - 参数依赖检测和提示

#### 修改组件
1. `DataSourcePanel.tsx`
   - 顶部显示当前页面名称
   - 添加"快速创建"入口
   - 数据源列表显示模板类型图标
   - 参数依赖卡片展示

### Phase 3: Mock数据表格编辑器 (4-5小时)
#### 新增组件
1. `MockDataEditor.tsx`
   - JSON/Table模式切换
   - 状态管理(编辑中的数据)

2. `MockDataTable.tsx`
   - 表格渲染(基于react-table或自实现)
   - 单元格编辑
   - 添加/删除行
   - 添加/删除列
   - 类型推断和验证

#### 功能实现
- 双向同步: Table ↔️ JSON
- 错误处理: 格式不合法时提示
- 空状态: 无数据时显示引导

### Phase 4: 参数关联优化 (2小时)
1. URL输入框参数高亮
2. 参数来源追踪
   - 哪个页面会跳转到这里
   - 哪个事件配置了参数传递
3. 参数缺失警告
   - 数据源需要param.id但页面没有定义

### Phase 5: 代码生成适配 (1-2小时)
修改`transformer.ts`适配页面级数据源:
```typescript
function transformPageToIR(schema: FSPSchema, pageDef: PageDef): IRPage {
  // 使用 pageDef.dataSources 而不是 schema.dataSources
  const sortedDataSources = sortDataSourcesByDependency(
    pageDef.dataSources ?? []
  )
  // ...
}
```

## 技术难点和解决方案
### 1. 数据迁移兼容性
**问题**: 用户已有项目使用全局dataSources,升级后如何兼容?

**方案**: 在导入schema时自动迁移
```typescript
function migrateSchema(schema: FSPSchema): FSPSchema {
  if (schema.dataSources && schema.dataSources.length > 0) {
    // 迁移到第一个页面
    if (schema.pages && schema.pages[0]) {
      schema.pages[0].dataSources = schema.dataSources
      delete schema.dataSources
    }
  }
  return schema
}
```

### 2. 跨页面数据源引用
**问题**: 页面级后,如何处理跨页面的数据源依赖?

**方案**: 不支持跨页面引用,每个页面独立管理
- 如果需要复用,提供"复制数据源到其他页面"功能
- 或者保留一个"全局数据源"高级选项

### 3. 表格编辑器复杂度
**问题**: 实现完整表格编辑器工作量大

**方案**: 分阶段实现
- MVP: 只支持简单的字符串编辑,每个单元格是input
- V2: 类型识别,number单元格用number input
- V3: 富文本,日期选择器等高级编辑器

## 用户体验提升点
1. **零配置快速开始**
   - 新建"商品列表页",点击"添加列表接口",自动生成完整mock数据
   - 拖入List组件,自动绑定数据源

2. **智能提示**
   - 输入URL时,实时检测参数
   - 缺少参数时,提示如何配置跳转

3. **可视化关系**
   - 显示"首页 → 详情页"的跳转关系
   - 高亮参数传递路径

4. **错误预防**
   - 删除数据源前,检查是否有组件在使用
   - 参数类型不匹配时警告

## 成功指标
- 创建列表-详情页面从15分钟降低到3分钟
- Mock数据配置错误率从30%降低到5%
- 新用户完成首个完整流程的成功率从40%提升到80%

## 风险评估
### 技术风险
- **数据结构破坏性变更**: 需要完善的迁移逻辑
  - 缓解: 充分测试,提供rollback脚本

- **表格编辑器性能**: 大数据量时卡顿
  - 缓解: 限制mock数据最多50行,虚拟滚动

### 产品风险
- **用户习惯改变**: 已有用户不适应新界面
  - 缓解: 提供迁移引导,保留"专家模式"(JSON编辑)

## 后续优化方向
1. 数据源测试功能增强
   - 支持mock API server,实时测试
   - 保存测试用例

2. 数据源市场
   - 预设常见API模板(电商/内容/社交)
   - 用户分享自定义模板

3. 智能生成
   - 根据mock数据自动生成组件布局
   - AI推荐最佳数据源配置